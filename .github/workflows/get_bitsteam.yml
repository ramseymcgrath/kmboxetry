name: Generate Cynthion Bitstream

on:
  push:
    paths:
      - 'hdl/**'
      - '.github/workflows/generate-bitstream.yml'
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-bitstream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake python3-pip python3-dev \
            libboost-all-dev libeigen3-dev zlib1g-dev libftdi1-dev \
            python3-setuptools python3-wheel

      - name: Setup FPGA toolchain
        run: |
          # Install OSS CAD Suite which includes Yosys, nextpnr, and other FPGA tools
          wget -O oss-cad-suite.tgz "https://github.com/YosysHQ/oss-cad-suite-build/releases/download/2023-05-05/oss-cad-suite-linux-x64-20230505.tgz"
          mkdir -p oss-cad-suite
          tar -xzf oss-cad-suite.tgz -C oss-cad-suite --strip-components=1
          echo "PATH=$(pwd)/oss-cad-suite/bin:$PATH" >> $GITHUB_ENV

      - name: Install Python requirements
        run: |
          python3 -m pip install --upgrade pip
          
          # Install dependencies first
          python3 -m pip install networkx setuptools wheel pyvcd
          python3 -m pip install usb pytest
          
          # Install HDL tools one by one to handle dependencies better
          python3 -m pip install migen
          python3 -m pip install nmigen
          python3 -m pip install amaranth
          
          # Now install luna with explicit dependency resolution
          python3 -m pip install git+https://github.com/greatscottgadgets/luna.git

      - name: Clone Cynthion repository if needed
        if: ${{ !contains(github.repository, 'cynthion') }}
        run: |
          git clone --recursive https://github.com/greatscottgadgets/cynthion.git cynthion-repo

      - name: Build bitstream
        run: |
          # If running in the Cynthion repository
          if [[ "$GITHUB_REPOSITORY" == *"cynthion"* ]]; then
            CYNTHION_DIR="."
          else
            CYNTHION_DIR="./cynthion-repo"
          fi
          
          cd $CYNTHION_DIR
          
          # Print directory structure for debugging
          echo "Current directory: $(pwd)"
          ls -la
          
          # Run the build system (adjust paths as needed for your specific Cynthion setup)
          if [ -d "hardware/luna" ]; then
            cd hardware/luna
          elif [ -d "luna" ]; then
            cd luna
          else
            echo "Cannot find luna directory, trying amaranth_boards directly"
          fi
          
          echo "Build directory: $(pwd)"
          ls -la
          
          # Try to build the bitstream
          python3 -m amaranth_boards.cynthion create-bitstream || {
            echo "Failed with amaranth_boards.cynthion, trying alternative approaches..."
            
            # Try alternate build commands if first one fails
            if [ -f "cynthion.py" ]; then
              python3 cynthion.py
            elif [ -d "gateware" ]; then
              cd gateware
              if [ -f "build.py" ]; then
                python3 build.py
              fi
            fi
          }
          
          # Create directory for artifacts and collect bitstream files
          mkdir -p ${{ github.workspace }}/bitstream_artifacts
          find $CYNTHION_DIR -name "*.bit" -o -name "*.svf" | xargs -I {} cp {} ${{ github.workspace }}/bitstream_artifacts/ || echo "No bitstream files found"
          
          # List what we found
          echo "Bitstream artifacts:"
          ls -la ${{ github.workspace }}/bitstream_artifacts/

      - name: Generate Changelog
        if: github.ref_type == 'tag'
        run: |
          echo "# Cynthion Bitstream Release" > ${{ github.workspace }}-CHANGELOG.txt
          echo "" >> ${{ github.workspace }}-CHANGELOG.txt
          echo "Generated on: $(date)" >> ${{ github.workspace }}-CHANGELOG.txt
          echo "" >> ${{ github.workspace }}-CHANGELOG.txt
          echo "## Included Files" >> ${{ github.workspace }}-CHANGELOG.txt
          
          # Check if directory exists and has files
          if [ -d "${{ github.workspace }}/bitstream_artifacts" ] && [ "$(ls -A ${{ github.workspace }}/bitstream_artifacts)" ]; then
            for file in $(find ${{ github.workspace }}/bitstream_artifacts -type f); do
              echo "* $(basename $file)" >> ${{ github.workspace }}-CHANGELOG.txt
            done
          else
            echo "* No bitstream files were generated" >> ${{ github.workspace }}-CHANGELOG.txt
          fi
          
          cat ${{ github.workspace }}-CHANGELOG.txt

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cynthion-bitstream
          path: ${{ github.workspace }}/bitstream_artifacts/
          if-no-files-found: warn

      - name: Release
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          body_path: ${{ github.workspace }}-CHANGELOG.txt
          files: ${{ github.workspace }}/bitstream_artifacts/*
          # Uncomment and modify if you want to release to a different repository
          # repository: username/repository-name
          # token: ${{ secrets.CUSTOM_GITHUB_TOKEN }}
