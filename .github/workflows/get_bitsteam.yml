name: Generate Cynthion Bitstream

on:
  push:
    paths:
      - 'hdl/**'
      - '.github/workflows/generate-bitstream.yml'
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-bitstream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake python3-pip python3-dev \
            libboost-all-dev libeigen3-dev zlib1g-dev libftdi1-dev \
            python3-setuptools python3-wheel

      - name: Setup FPGA toolchain
        run: |
          # Install OSS CAD Suite which includes Yosys, nextpnr, and other FPGA tools
          wget -O oss-cad-suite.tgz "https://github.com/YosysHQ/oss-cad-suite-build/releases/download/2023-05-05/oss-cad-suite-linux-x64-20230505.tgz"
          mkdir -p oss-cad-suite
          tar -xzf oss-cad-suite.tgz -C oss-cad-suite --strip-components=1
          echo "PATH=$(pwd)/oss-cad-suite/bin:$PATH" >> $GITHUB_ENV

      - name: Install Python requirements
        run: |
          python3 -m pip install --upgrade pip
          
          # Install dependencies first
          python3 -m pip install networkx setuptools wheel pyvcd
          python3 -m pip install usb pytest
          
          # Install HDL tools one by one to handle dependencies better
          python3 -m pip install migen
          python3 -m pip install nmigen
          python3 -m pip install amaranth amaranth-boards
          
          # Now install luna with explicit dependency resolution
          python3 -m pip install git+https://github.com/greatscottgadgets/luna.git

      - name: Clone Cynthion repository if needed
        if: ${{ !contains(github.repository, 'cynthion') }}
        run: |
          git clone --recursive https://github.com/greatscottgadgets/cynthion.git cynthion-repo

      - name: Examine Cynthion repository structure
        run: |
          # Determine repo directory
          if [[ "$GITHUB_REPOSITORY" == *"cynthion"* ]]; then
            CYNTHION_DIR="."
          else
            CYNTHION_DIR="./cynthion-repo"
          fi
          
          cd $CYNTHION_DIR
          
          echo "Examining repository structure:"
          find . -type d -name "gateware" -o -name "hdl" | sort
          echo ""
          
          echo "Checking for build scripts:"
          find . -name "*.py" -exec grep -l "build\|synthesis\|bitstream" {} \; | sort

      - name: Build bitstream
        run: |
          # If running in the Cynthion repository
          if [[ "$GITHUB_REPOSITORY" == *"cynthion"* ]]; then
            CYNTHION_DIR="."
          else
            CYNTHION_DIR="./cynthion-repo"
          fi
          
          cd $CYNTHION_DIR
          
          # Based on the repository structure seen in the logs
          if [ -d "cynthion/gateware" ]; then
            echo "Found cynthion/gateware directory, trying to build there..."
            cd cynthion/gateware
            
            # List Python files to understand what to run
            ls -la *.py || echo "No Python files found in this directory"
            
            # Try to find a build script
            if [ -f "build.py" ]; then
              python3 build.py
            elif [ -f "top.py" ]; then
              python3 top.py build
            else
              echo "No build script found. Trying to find other build methods..."
              for py_file in $(ls *.py 2>/dev/null); do
                echo "Trying to run: $py_file"
                python3 $py_file || echo "Failed to run $py_file"
              done
            fi
          elif [ -f "cynthion/cynthion.py" ]; then
            echo "Found cynthion/cynthion.py, trying to build using it..."
            cd cynthion
            python3 cynthion.py build
          else
            echo "Cannot find expected build structure. Examining BUILD.md for guidance..."
            cat BUILD.md || echo "BUILD.md not found"
            
            echo "Trying to follow any visible build instructions..."
            # As a last resort, if there's a Makefile, try using it
            if [ -f "Makefile" ]; then
              make bitstream || make all || make
            fi
          fi
          
          # Create directory for artifacts and collect bitstream files
          mkdir -p ${{ github.workspace }}/bitstream_artifacts
          
          # Look for bitstream files more thoroughly
          echo "Searching for bitstream files..."
          find $CYNTHION_DIR -type f -name "*.bit" -o -name "*.svf" -o -name "*.bin" | tee bitstream_files.txt
          
          # Copy any found bitstream files
          if [ -s bitstream_files.txt ]; then
            cat bitstream_files.txt | xargs -I {} cp {} ${{ github.workspace }}/bitstream_artifacts/
            echo "Copied bitstream files to artifacts directory"
          else
            echo "No bitstream files found"
          fi
          
          # List what we found
          echo "Bitstream artifacts:"
          ls -la ${{ github.workspace }}/bitstream_artifacts/

      - name: Generate Changelog
        if: github.ref_type == 'tag'
        run: |
          echo "# Cynthion Bitstream Release" > ${{ github.workspace }}-CHANGELOG.txt
          echo "" >> ${{ github.workspace }}-CHANGELOG.txt
          echo "Generated on: $(date)" >> ${{ github.workspace }}-CHANGELOG.txt
          echo "" >> ${{ github.workspace }}-CHANGELOG.txt
          echo "## Included Files" >> ${{ github.workspace }}-CHANGELOG.txt
          
          # Check if directory exists and has files
          if [ -d "${{ github.workspace }}/bitstream_artifacts" ] && [ "$(ls -A ${{ github.workspace }}/bitstream_artifacts)" ]; then
            for file in $(find ${{ github.workspace }}/bitstream_artifacts -type f); do
              echo "* $(basename $file)" >> ${{ github.workspace }}-CHANGELOG.txt
            done
          else
            echo "* No bitstream files were generated" >> ${{ github.workspace }}-CHANGELOG.txt
          fi
          
          cat ${{ github.workspace }}-CHANGELOG.txt

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cynthion-bitstream
          path: ${{ github.workspace }}/bitstream_artifacts/
          if-no-files-found: warn

      - name: Release
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          body_path: ${{ github.workspace }}-CHANGELOG.txt
          files: ${{ github.workspace }}/bitstream_artifacts/*
          # Uncomment and modify if you want to release to a different repository
          # repository: username/repository-name
          # token: ${{ secrets.CUSTOM_GITHUB_TOKEN }}
